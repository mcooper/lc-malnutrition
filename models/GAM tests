library(mgcv)
library(tidyverse)

setwd('~/../mattcoop/mortalityblob/dhs/')

hh <- read.csv('HH_data_A.csv')
spei <- read.csv('PrecipIndices.csv')
spei2 <- read.csv('PrecipIndicesShortTerm.csv')

afr <- Reduce(f=function(x, y){merge(x, y, all.x=T, all.y=F)},
              list(hh, spei, spei2)) %>%
  filter(latitude < 20 & longitude > -25 & longitude < 75)

#Every combination of:
  #haz vs whz
  #spei1, 2, 3, 6, 12, 24, 36, 
  #REML vs GCV

df <- expand.grid(list(z=c('haz', 'whz'),
                       spei=c('1', '2', '3', '6', '12', '24', '36'),
                       method=c('REML', 'GCV.Cp'),
                       cs=c('fe', '')),
                  stringsAsFactors = F)

runAndWrite <- function(name, formula, method){
  assign(name, bam(as.formula(formula), data=afr, method=method))
  save(list=name, file = paste0('/home/mattcoop/mortalityblob/lc_gams/', name, '.Rdata'))
  rm(list=name)
}

for (i in 1:nrow(df)){
  
  if(df$method[i]=='REML'){
    next
  }
  
  name <- paste0(df[i, ], collapse='')
  
  formula <- paste0(df$z[i], '_dhs ~ age + as.factor(calc_birthmonth) + birth_order + hhsize + sex + mother_years_ed + toilet + head_age + head_sex + wealth_index + interview_year + s(spei',
                    df$spei[i], ')', ifelse(df$cs[i]=='fe', ' + country + surveycode', ''))
  
  runAndWrite(name, formula, method=df$method[i])
  
  print(i/nrow(df))
  print(name)
}



setwd('/home/mattcoop/mortalityblob/lc_gams/')

for (f in list.files(pattern='whz|haz')){
  load(f)
  cat("AIC(", gsub('.Rdata', '', f), ")\n", sep = "")
}

AIC(haz12GCV.Cp)
AIC(haz12GCV.Cpfe)
AIC(haz12REML)
AIC(haz12REMLfe)
AIC(haz1GCV.Cp)
AIC(haz1GCV.Cpfe)
AIC(haz1REML)
AIC(haz1REMLfe)
AIC(haz24GCV.Cp)
AIC(haz24GCV.Cpfe)
AIC(haz24REML)
AIC(haz24REMLfe)
AIC(haz2GCV.Cp)
AIC(haz2GCV.Cpfe)
AIC(haz2REML)
AIC(haz2REMLfe)
AIC(haz36GCV.Cp)
AIC(haz36GCV.Cpfe)
AIC(haz36REML)
AIC(haz36REMLfe)
AIC(haz3GCV.Cp)
AIC(haz3GCV.Cpfe)
AIC(haz3REML)
AIC(haz3REMLfe)
AIC(haz6GCV.Cp)
AIC(haz6GCV.Cpfe)
AIC(haz6REML)
AIC(haz6REMLfe)



AIC(whz12GCV.Cp)
AIC(whz12GCV.Cpfe)
AIC(whz12REML)
AIC(whz12REMLfe)
AIC(whz1GCV.Cp)
AIC(whz1GCV.Cpfe)
AIC(whz1REML)
AIC(whz1REMLfe)
AIC(whz24GCV.Cp)
AIC(whz24GCV.Cpfe)
AIC(whz24REML)
AIC(whz24REMLfe)
AIC(whz2GCV.Cp)
AIC(whz2GCV.Cpfe)
AIC(whz2REML)
AIC(whz2REMLfe)
AIC(whz36GCV.Cp)
AIC(whz36GCV.Cpfe)
AIC(whz36REML)
AIC(whz36REMLfe)
AIC(whz3GCV.Cp)
AIC(whz3GCV.Cpfe)
AIC(whz3REML)
AIC(whz3REMLfe)
AIC(whz6GCV.Cp)
AIC(whz6GCV.Cpfe)
AIC(whz6REML)
AIC(whz6REMLfe)



